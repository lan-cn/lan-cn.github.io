<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/js/mdui.min.js" integrity="sha384-gCMZcshYKOGRX9r6wbDrvF+TcCCswSHFucUzUPwka+Gr+uHgjlYvkABr95TCOz3A" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/css/mdui.min.css" integrity="sha384-cLRrMq39HOZdvE0j6yBojO4+1PrHfB7a9l5qLcmRm/fiWXYY+CndJPmyu5FV/9Tw" crossorigin="anonymous" />

    <script type="text/javascript" src="http://lan-cn.gitee.io/mdchat/mdchat.js"></script>

    <script type="text/javascript" src="https://lan-cn.gitee.io/js/Valine.min.js"></script>

    <script type="text/javascript" src="https://lan-cn.gitee.io/js/av-min.js"></script>

    <script src="mdchat.js"></script>

    <style>
        .m d-section {
            display: flex;
            margin: 15px 0
        }
        
        .mdchat-form,
        .mdchat-comment {
            flex: 1;
            margin-left: 15px;
            overflow: hidden
        }
        
        .mdchat-form-inputs {
            display: flex
        }
        
        .mdchat-form-inputs>input,
        .mdchat-textarea {
            outline: 0;
            width: 100%;
            font: inherit;
            transition: all .3s
        }
        
        .mdchat-form-inputs>input:focus,
        .mdchat-form-inputs>input {
            padding: 7px;
            margin-left: 10px
        }
        
        .mdchat-form-inputs>input:first-child {
            margin: 0
        }
        
        .mdchat-textarea {
            margin: 10px 0;
            padding: 10px;
            min-height: 80px;
            max-height: 300px;
            overflow: auto
        }
        
        .mdchat-controls {
            display: flex
        }
        
        .mdchat-badge {
            flex: 1
        }
        
        .mdchat-badge>a:first-child {
            margin-right: 10px
        }
        
        .mdchat-markdown img {
            max-width: 90%
        }
    </style>
    <title>白篮小站</title>
</head>

<div id="sidebar" class="mdui-drawer mdui-drawer-full-height mdui-drawer-close mdui-color-white">
    <!-- 侧边栏 -->
    <div>
        <ul class="mdui-list">
            <li class="mdui-subheader">白篮</li>
            <li mdui-dialog="{target: '#about'}" class="mdui-list-item mdui-ripple"> <i class="mdui-list-item-icon mdui-icon material-icons" style="color: rgba(0, 0, 0, 0.54);">info_outline</i>
                <div class="mdui-list-item-content">关于</div>
            </li>
            <li class="mdui-list-item mdui-ripple" onclick="window.open('https://gitee.com/lan-cn');"> <i class="mdui-list-item-icon mdui-icon material-icons" style="color: rgba(0, 0, 0, 0.54);">account_circle</i>
                <div class="mdui-list-item-content">gitee
                </div>
            </li>
            <li class="mdui-list-item mdui-ripple" onclick="window.open('https://github.com/lan-cn');"> <i class="mdui-list-item-icon mdui-icon material-icons" style="color: rgba(0, 0, 0, 0.54);">account_circle</i>
                <div class="mdui-list-item-content">github
                </div>
            </li>
        </ul>
    </div>
</div>
<div class="mdui-dialog" id="about">
    <div class="mdui-dialog-title">关于</div>
    <div class="mdui-dialog-content">一个男孩纸 (ˉ▽￣～)</div>
    <div class="mdui-dialog-actions">
        <button class="mdui-btn mdui-ripple mdui-color-deep-purple-accent" mdui-dialog-close>关闭</button>
    </div>
</div>
<div class="mdui-dialog" id="upg">
    <div class="mdui-dialog-title"></div>
    <div class="mdui-dialog-content"></div>
    <div class="mdui-dialog-actions">
        <button class="mdui-btn mdui-ripple mdui-color-deep-purple-accent" mdui-dialog-close>关闭</button>
    </div>
</div>
<div class="mdui-dialog" id="shit">
    <div class="mdui-dialog-title">o(≧口≦)o</div>
    <div class="mdui-dialog-content">我就是一条提示信息，点我干什么！！！</div>
    <div class="mdui-dialog-actions">
        <button class="mdui-btn mdui-ripple mdui-color-deep-purple-accent" mdui-dialog-close>关闭</button>
    </div>
</div>


<body class="mdui-bottom-nav-fixed">
    <div class="mdui-container">
        <div id="sideba">
            <div>
                <ul class="mdui-list">
                    <li class="mdui-list-item mdui-ripple" mdui-dialog="{target: '#shit'}">
                        <i class="mdui-icon material-icons">warning</i>
                        <div class="mdui-list-item-content">&nbsp;站长要上高中啦！</div>
                    </li>
                    <li class="mdui-list-item mdui-ripple" mdui-dialog="{target: '#shit'}">
                        <i class="mdui-icon material-icons">done</i>
                        <div class="mdui-list-item-content">&nbsp;实在选不出一张好看的网页背景，那就不要背景了吧</div>
                    </li>
                    <li class="mdui-list-item mdui-ripple" mdui-dialog="{target: '#shit'}">
                        <i class="mdui-icon material-icons">cloud_queue</i>
                        <div class="mdui-list-item-content">&nbsp;vercel大法好！</div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="mdui-toolbar mdui-color-deep-purple-accent">
            <button mdui-drawer="{target:'#sidebar',overlay:true,swipe:true}" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon material-icons">menu</i></button>
            <a href="javascript:;" class="mdui-typo-headline">白篮</a>
            <a href="javascript:;" mdui-ripple mdui-ripple-black>蒟蒻</a>
            <div class="mdui-toolbar-spacer"></div>
        </div>
        <div>&nbsp;</div>
        <div class="mdui-panel mdui-panel-gapless" mdui-panel>
            <div class="mdui-panel-item mdui-panel-item-open">
                <div class="mdui-panel-item-header">日程</div>
                <div class="mdui-panel-item-body">
                    <p>中考复习</p>
                </div>
            </div>
            <div class="mdui-panel-item mdui-panel-item-open">
                <div class="mdui-panel-item-header">项目</div>
                <div class="mdui-panel-item-body">
                    <div class="mdui-panel" mdui-panel>
                        <div class="mdui-panel-item">
                            <div class="mdui-panel-item-header" onClick="eblock()">eblock-图形化编程网站</div>
                        </div>
                    </div>
                    <div class="mdui-panel" mdui-panel>
                        <div class="mdui-panel-item">
                            <div class="mdui-panel-item-header" onClick="mdchat()">mdchat-mdui风格的评论系统</div>
                        </div>
                    </div>
                    <div class="mdui-panel" mdui-panel>
                        <div class="mdui-panel-item">
                            <div class="mdui-panel-item-header" onClick="pg()">PlayGo对战平台（画饼中</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mdui-panel-item mdui-panel-item-open">
                <div class="mdui-panel-item-header">资源下载</div>
                <div class="mdui-panel-item-body">
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content">kalilinux 2020 安装镜像 （提取码：qgie）<button class="mdui-float-right mdui-btn mdui-btn-raised mdui-ripple" onClick="d1()">下载</button></div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content">win10 lstc 安装镜像 （提取码tfhj）<button class="mdui-float-right mdui-btn mdui-btn-raised mdui-ripple" onClick="d2()">下载</button></div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content">win10 1903 安装镜像 （提取码3e58）<button class="mdui-float-right mdui-btn mdui-btn-raised mdui-ripple" onClick="d3()">下载</button></div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content">win7 安装镜像 （提取码av5f）<button class="mdui-float-right mdui-btn mdui-btn-raised mdui-ripple" onClick="d4()">下载</button></div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content">GTA5 1.36 （提取码njqr）<button class="mdui-float-right mdui-btn mdui-btn-raised mdui-ripple" onClick="d5()">下载</button></div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content">无人深空 （提取码7upo）<button class="mdui-float-right mdui-btn mdui-btn-raised mdui-ripple" onClick="d6()">下载</button></div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content">logic工程大全 （提取码mvtu）<button class="mdui-float-right mdui-btn mdui-btn-raised mdui-ripple" onClick="d7()">下载</button></div>
                    </li>
                </div>
            </div>
        </div>
        <div class="mdui-panel-item mdui-panel-item-open">
            <div class="mdui-panel-item-header">联系方式</div>
            <div class="mdui-panel-item-body">
                <div class="mdui-table-fluid">
                    <table class="mdui-table mdui-table-hoverable">
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>码云</td>
                                <td>https://gitee.com/lan-cn</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>github</td>
                                <td>https://github.com/lan-cn</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>洛谷</td>
                                <td>https://www.luogu.com.cn/user/374048</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>知乎</td>
                                <td>https://www.zhihu.com/people/bai-lan-69-45</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>bilibili</td>
                                <td>https://space.bilibili.com/475755598</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td>steam</td>
                                <td>https://steamcommunity.com/id/mercin/</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>7</td>
                                <td>编程猫</td>
                                <td>https://shequ.codemao.cn/user/2887623</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>8</td>
                                <td>邮箱</td>
                                <td>doutianyang@163.com</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>9</td>
                                <td>qq号</td>
                                <td>82954066</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="mdui-panel" mdui-panel>
            <div class="mdui-panel-item mdui-panel-item-open">
                <div class="mdui-panel-item-header">留言板</div>
                <div class="mdui-container">
                    <div id="pagetalk"></div>
                </div>
                <div>&nbsp;</div>
                <script>
                    new PageTalk({
                        container: '#pagetalk',
                        appId: 'D3fsiiYIxKKwtBYcSxJk4BfR-gzGzoHsz',
                        appKey: 'lmLhdLOSgyWI9fpchm88hUSC'
                    })
                </script>
            </div>
        </div>


        <div>&nbsp;</div>
        <div class="mdui-table-fluid">
            <table class="mdui-table mdui-table-selectable">
                <thead>
                    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;提交网站bug</p>
                    <tr>
                        <td>显示错误</td>
                    </tr>
                    <tr>
                        <td>网站卡顿</td>
                    </tr>
                    <tr>
                        <td>内容无法加载</td>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div class="mdui-container">
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">请输入文字</label>
                    <input class="mdui-textfield-input" type="report" />
                </div>
                <div>&nbsp;</div>
                <div class="mdchat-controls">
                    <div class="mdchat-badge">
                        <button class="mdui-float-right mdui-btn mdui-ripple" mdui-dialog="{target: '#example-1'}">提交</button>
                        <div class="mdui-dialog" id="example-1">
                            <div class="mdui-dialog-content">你提交了，但是没完全提交</div>
                            <div class="mdui-dialog-actions">
                                <button class="mdui-btn mdui-ripple mdui-color-deep-purple-accent" mdui-dialog-close>等我把这个功能做出来的</button>
                            </div>
                        </div>
                        <div>&nbsp;</div>
                    </div>
                </div>
            </div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <script>
                function d1() {
                    window.location.href = "https://pan.baidu.com/s/1MsDR3MTfO9_12tTdV459oQ"
                }

                function d2() {
                    window.location.href = "https://pan.baidu.com/s/1Z51PsKG0GJRnQ_BRgC7njg"
                }

                function d3() {
                    window.location.href = "https://pan.baidu.com/s/1ZMLMmHrU6v6K2gNz6IcmCA"
                }

                function d4() {
                    window.location.href = "https://pan.baidu.com/s/1TDod9UceSGNPoBrU5Cvb3w"
                }

                function d5() {
                    window.location.href = "https://pan.baidu.com/s/1UsILykBLaLafZ7QD8iavdA"
                }

                function d6() {
                    window.location.href = "https://pan.baidu.com/s/1yKVUysrbyHiOdvBHdoQQZw"
                }

                function d7() {
                    window.location.href = "https://pan.baidu.com/s/1yR1r02sM7XWggoPHrekSgQ"
                }

                function eblock() {
                    window.location.href = "https://gitee.com/lan-cn/eblock"
                }

                function mdchat() {
                    window.location.href = "https://gitee.com/lan-cn/mdchat"
                }

                function mdchat() {
                    window.location.href = "https://gitee.com/lan-cn/mdchat"
                }

                function pg() {
                    window.location.href = "https://gitee.com/lan-cn/playgo"
                }
            </script>
            <script>
                //搬过来的，对照mdui做了些小改动
class PageTalk {
    constructor(options) {
        this.importScripts([
            'https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js',
            'https://cdn.jsdelivr.net/npm/marked@0.6.3/marked.min.js'
        ]).then(() => {
            marked.setOptions({
                sanitize: true
            })
            this.className = options.className || 'PageTalk_Comment'
            this.lcs = new LeanCloudStorage(options)
            this.listComments()
        })

        this.emailReg = /^[a-zA-Z0-9_\-\.]+\@[a-zA-Z0-9_\-\.]+\.([a-zA-Z]{2,8})$/
        this.urlReg = /^https?:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z0-9\-\.]+(\:\d+)?[\w\-\/\.@?=%&+#]*$/
        this.avatar = ''
        this.onMessage = options.onMessage || function() {}
        this.createHeader(options.container)
    }

    createHeader(container) {
        container = document.querySelector(container)
        container.innerHTML = ''

        const user = this.loadLastUser()
        const header = this._(`
        <div class="mdchat-container"><div class="mdchat-section"><div class="mdchat-form"><div class="mdchat-form-inputs"><input type="text" id="mdchat-nickname" value="${user.nickname}" maxlength="20" placeholder="昵称" class="mdui-textfield-input" type="email"><input type="text" id="mdchat-email" value="${user.email}" maxlength="20" placeholder="邮箱" class="mdui-textfield-input"><input type="text" id="mdchat-website" value="${user.website}" maxlength="20" placeholder="网站" class="mdui-textfield-input"></div><div class="mdchat-textarea mdui-textfield-input" placeholder="请输入内容" contenteditable="plaintext-only"></div><div class="mdchat-controls"><div class="mdchat-badge"><div class="mdchat-message mdui-container-fluid"></div></div><button class="mdui-btn mdui-ripple mdui-color-deep-purple-accent">发言</button></div></div></div><div id="mdchat-comment-list"></div>
        `)

        header.querySelector('.mdchat-submit').addEventListener('click', e => this.addComment(e))
        container.appendChild(header)

        this.element = {
            nickname: header.querySelector('#mdchat-nickname'),
            email: header.querySelector('#mdchat-email'),
            website: header.querySelector('#mdchat-website'),
            textarea: header.querySelector('.mdchat-textarea'),
            message: header.querySelector('.mdchat-message'),
            submit: header.querySelector('.mdchat-submit'),
            comments: header.querySelector('#mdchat-comment-list')
        }
    }

    async listComments() {
        this.setMessage(`正在加载...`)
        const res = await this.lcs.queryObjects(`select * from ${this.className} where pageId = '${location.pathname}' order by createdAt desc`)
        if (res.error) {
            return this.setMessage(res.error, true)
        }

        this.setMessage(`共 ${res.results.length} 条发言`)
        res.results.forEach(comment => {
            const markedComment = this.markComment(comment)
            const section = this.createSection(markedComment)
            this.element.comments.appendChild(section)
        })
    }

    async addComment(e) {
        const textarea = this.element.textarea
        const comment = {
            nickname: this.element.nickname.value.trim(),
            email: this.element.email.value.trim(),
            website: this.element.website.value.trim(),
            content: (textarea.orginalContent || textarea.textContent).trim(),
            pageId: location.pathname
        }
        let res = this.verifyFormData(comment)
        if (res !== true) {
            return this.setMessage(res, true)
        }

        this.element.submit.disabled = true
        res = await this.lcs.insertObject(this.className, comment)
        this.element.submit.disabled = false
        if (res.error) {
            return this.setMessage(res.error, true)
        }

        comment.objectId = res.objectId
        comment.createdAt = res.createdAt
        const markedComment = this.markComment(comment)
        const section = this.createSection(markedComment)
        const list = this.element.comments.children

        if (list.length === 0) {
            this.element.comments.appendChild(section)
        } else {
            this.element.comments.insertBefore(section, list[0])
        }

        this.setMessage(`共 ${list.length} 条发言`)
        this.clearPreview()
        this.saveLastUser(markedComment)
        this.onMessage(markedComment)
    }

    createSection(comment) {
        const item = this._(`
        <div class="mdui-typo">
        <blockquote>
        <div class="mdchat-section">
        <div class="mdchat-comment">
        <div class="mdchat-profile">
        <div></div><footer>
        ${comment.nickname}</footer>
        <svg id="mdchat-reply-icon" viewBox="0 0 1332 1024" width="14">
        <path d="M529.066665 273.066666 529.066665 0 51.2 477.866666 529.066665 955.733335 529.066665 675.84C870.4 675.84 1109.333335 785.066665 1280 1024 1211.733335 682.666665 1006.933335 341.333334 529.066665 273.066666"></path></svg>
        </div>
        <div class="mdchat-markdown">
        ${comment.htmlContent}</div></div></div></blockquote></div>`)
        item.querySelector('#mdchat-reply-icon').addEventListener('click', e => this.reply(comment))
        return item
    }

    reply(comment) {
        const lines = comment.content.split('\n')
        lines.forEach((line, i) => lines[i] = '> ')
        lines.unshift('> @' + comment.nickname)
        lines.push('\n\n')

        this.element.textarea.textContent = lines.join('\n')
        this.moveCursorToEnd(this.element.textarea)
    }

    markComment(comment) {
        comment.avatar = this.avatar
        comment.createdAt = this.formatDate(comment.createdAt)
        comment.htmlContent = marked(comment.content)
        return comment
    }

    verifyFormData(comment) {
        if (!comment.nickname) {
            return '昵称不能为空'
        }
        if (comment.nickname.match(/[\<\>]+/)) {
            return '昵称不能包含尖括号'
        }
        if (comment.email && !comment.email.match(this.emailReg)) {
            return '邮箱格式有误'
        }
        if (comment.website && !comment.website.match(this.urlReg)) {
            return '网站格式有误'
        }
        if (!comment.content) {
            return '发言内容不能为空'
        }
        if (comment.content.length > 2000) {
            return ' 2000 字限制'
        }
        return true
    }

    setMessage(message, isError = false) {
        this.element.message.innerHTML = message
        if (isError) {
            this.element.message.classList.add('mdchat-error')
        } else {
            this.element.message.classList.remove('mdchat-error')
        }
    }

    saveLastUser(comment) {
        localStorage.setItem('pagetalk-user', JSON.stringify({
            nickname: comment.nickname,
            email: comment.email,
            website: comment.website,
            avatar: comment.avatar
        }))
    }

    loadLastUser() {
        const user = JSON.parse(localStorage.getItem('pagetalk-user')) || {}
        user.nickname = user.nickname || ''
        user.email = user.email || ''
        user.website = user.website || ''
        user.avatar = user.avatar || this.avatar
        return user
    }

    formatDate(time) {
        time = (new Date(time)).getTime() + 8 * 3600 * 1000
        return (new Date(time)).toJSON().substr(0, 10).replace(/\-/g, '/')
    }

    moveCursorToEnd(element) {
        element.focus()
        element.scrollTop = element.scrollHeight - element.clientHeight

        if (window.getSelection) {
            const range = window.getSelection()
            range.selectAllChildren(element)
            range.collapseToEnd()
        } else if (document.selection) {
            const range = document.selection.createRange()
            range.moveToElementText(element)
            range.collapse(false)
            range.select()
        }
    }

    importScripts(urls) {
        return new Promise((resolve, reject) => {
            const head = document.getElementsByTagName('head')[0]
            const load = i => {
                const script = document.createElement('script')
                script.setAttribute('type', 'text/javaScript')
                script.setAttribute('src', urls[i])
                script.onload = script.onerror = () => {
                    i++
                    if (i === urls.length) resolve()
                    else load(i)
                }
                head.appendChild(script)
            }
            load(0)
        })
    }

    _(selector) {
        selector = selector.replace('/\n/mg', '').trim()
        if (selector.startsWith('<')) {
            const fragment = document.createRange().createContextualFragment(selector)
            return fragment.firstChild
        }
        return document.querySelector(selector)
    }
}

class LeanCloudStorage {
    constructor(options) {
        this.api = 'https://avoscloud.com/1.1'
        this.defaultHeaders = {
            'X-LC-Id': options.appId,
            'X-LC-Key': options.appKey,
            'Content-Type': 'application/json'
        }
    }

    async queryObjects(cql) {
        return await this.tryFetch(`/cloudQuery?cql=${cql}`)
    }

    async getObjects(className) {
        return await this.tryFetch(`/classes/${className}`)
    }

    async insertObject(className, object) {
        return await this.tryFetch(`/classes/${className}`, {
            method: 'POST',
            body: JSON.stringify(object)
        })
    }

    async deleteObject(className, objectId) {
        return await this.tryFetch(`/classes/${className}/${objectId}`, {
            method: 'DELETE'
        })
    }

    async tryFetch(url, options = {}) {
        options.headers = this.defaultHeaders
        try {
            const response = await fetch(this.api + url, options)
            return await response.json()
        } catch (e) {
            return {
                error: e.message
            }
        }
    }
}
            </script>
</body>

</html>
